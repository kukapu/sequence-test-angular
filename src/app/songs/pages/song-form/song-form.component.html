@if (form) {
  <form [formGroup]="form" class="song-form">
    <mat-form-field appearance="outline">
      <mat-label>Título</mat-label>
      <input matInput formControlName="title" placeholder="Introduce el título">
      @if (form.get('title')?.errors?.['required'] && form.get('title')?.touched) {
        <mat-error>El título es obligatorio</mat-error>
      }
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Artista</mat-label>
      <input matInput formControlName="artist" placeholder="Introduce el artista">
      @if (form.get('artist')?.errors?.['required'] && form.get('artist')?.touched) {
        <mat-error>El artista es obligatorio</mat-error>
      }
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Géneros</mat-label>
      <mat-select formControlName="genre"
                  multiple
                  (keydown.backspace)="removeLastGenre()">
        @for (genre of genres; track genre) {
          <mat-option [value]="genre">{{ genre }}</mat-option>
        }
      </mat-select>
      @if (form.get('genre')?.errors?.['required'] && form.get('genre')?.touched) {
        <mat-error>Selecciona al menos un género</mat-error>
      }
    </mat-form-field>

    <div class="companies-section">
      <mat-form-field appearance="outline" class="company-input">
        <mat-label>Compañía</mat-label>
        <input matInput
               #companyInput
               placeholder="Añade una compañía"
               (keyup.enter)="addCompany(companyInput.value, companyInput)">
      </mat-form-field>
      <button type="button"
              mat-icon-button
              color="primary"
              (click)="addCompany(companyInput.value, companyInput)">
        <mat-icon>add</mat-icon>
      </button>
    </div>

    <div class="chips-container">
      @for (company of companies(); track company; let i = $index) {
        <mat-chip-row (removed)="removeCompany(i)">
          {{ company }}
          <button matChipRemove>
            <mat-icon>cancel</mat-icon>
          </button>
        </mat-chip-row>
      }
    </div>

    <mat-form-field appearance="outline">
      <mat-label>País</mat-label>
      <input matInput
             type="text"
             [formControl]="countryFilterCtrl"
             [matAutocomplete]="auto"
             (keydown.backspace)="clearCountryOnBackspace($any($event))"
             (keydown.enter)="$any($event).stopPropagation()"
             placeholder="Buscar país">
      <mat-autocomplete #auto="matAutocomplete"
                       (optionSelected)="onCountrySelected($event)"
                       [displayWith]="displayFn"
                       [autoActiveFirstOption]="true">
        @for (country of filteredCountries(); track country) {
          <mat-option [value]="country">{{ country }}</mat-option>
        }
      </mat-autocomplete>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Año</mat-label>
      <input matInput
             type="number"
             [formControl]="yearNumberControl"
             [max]="maxDate.getFullYear()"
             [min]="1900"
             placeholder="Selecciona un año">
      <input [matDatepicker]="yearPicker"
             [formControl]="yearDateControl"
             class="cdk-visually-hidden">
      <button matSuffix
              mat-icon-button
              type="button"
              (click)="yearPicker.open()">
        <mat-icon>calendar_today</mat-icon>
      </button>
      <mat-datepicker #yearPicker
                      startView="multi-year"
                      (yearSelected)="onYearSelected($event); yearPicker.close()">
      </mat-datepicker>
      @if (form.get('year')?.errors?.['required'] && form.get('year')?.touched) {
        <mat-error>El año es obligatorio</mat-error>
      }
    </mat-form-field>

    <mat-form-field appearance="outline" subscriptSizing="dynamic">
      <mat-label>Puntuación</mat-label>
      <input matInput
             type="number"
             formControlName="rating"
             min="0"
             max="10"
             step="0.01"
             placeholder="0-10">
    </mat-form-field>
    @if (form.get('rating')?.errors && form.get('rating')?.touched) {
      <div class="error-message">
        @if (form.get('rating')?.errors?.['required']) {
          <mat-error>La puntuación es obligatoria</mat-error>
        } @else if (form.get('rating')?.errors?.['min'] || form.get('rating')?.errors?.['max']) {
          <mat-error>La puntuación debe estar entre 0 y 10</mat-error>
        } @else if (form.get('rating')?.errors?.['pattern']) {
          <mat-error>Máximo 2 decimales permitidos</mat-error>
        }
      </div>
    }

    <div class="form-actions">
      <button
        mat-raised-button
        color="primary"
        [disabled]="!form.valid"
        (click)="onSubmit()"
      >
        Guardar
      </button>
    </div>
  </form>
}
